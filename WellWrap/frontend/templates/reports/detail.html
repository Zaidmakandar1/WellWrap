{% extends "base.html" %}

{% block title %}Report Analysis - WellWrap{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-custom">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('dashboard') }}">
                        <i class="fas fa-tachometer-alt me-1"></i>
                        Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('patient_history') }}">
                        <i class="fas fa-history me-1"></i>
                        History
                    </a>
                </li>
                <li class="breadcrumb-item active">Report Analysis</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-1" style="color: var(--primary-color);">
                    <i class="fas fa-file-medical me-2"></i>
                    WellWrap Medical Analysis
                </h2>
                <p class="text-muted mb-0">
                    AI-powered analysis and insights from your medical report
                </p>
            </div>
            <div>
                <a href="{{ url_for('patient_history') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back to History
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Health Score Overview -->
<div class="row mb-4">
    <div class="col-lg-4">
        <div class="card text-center" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
            <div class="card-body">
                <h3 class="mb-1">{{ analysis_results.health_score or report.health_score or 0 }}/100</h3>
                <p class="mb-2">{{ analysis_results.overall_status or 'Health Score' }}</p>
                <small>{{ analysis_results.status_description or 'Analysis completed' }}</small>
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <h6><i class="fas fa-info-circle me-2"></i>Report Information</h6>
                <div class="row">
                    <div class="col-md-6">
                        <small><strong>File:</strong> {{ report.original_filename }}</small><br>
                        <small><strong>Type:</strong> {{ report.report_type }}</small><br>
                        <small><strong>Date:</strong> {{ report.upload_date.strftime('%B %d, %Y') }}</small>
                    </div>
                    <div class="col-md-6">
                        <small><strong>Tests Analyzed:</strong> {{ analysis_results.total_tests or 0 }}</small><br>
                        <small><strong>Normal Results:</strong> {{ analysis_results.normal_tests or 0 }}</small><br>
                        <small><strong>Status:</strong> 
                            <span class="badge bg-success">{{ report.status.title() }}</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Analysis Results -->
{% if analysis_results.test_results %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-microscope me-2"></i>
                    Test Results Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for test in analysis_results.test_results %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="border rounded p-3 h-100">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">{{ test.test_name }}</h6>
                                {% if test.status == 'normal' %}
                                    <span class="badge bg-success">Normal</span>
                                {% elif test.status == 'high' %}
                                    <span class="badge bg-danger">High</span>
                                {% elif test.status == 'low' %}
                                    <span class="badge bg-warning">Low</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ test.status.title() }}</span>
                                {% endif %}
                            </div>
                            <div class="mb-2">
                                <strong>{{ test.value }} {{ test.unit }}</strong>
                            </div>
                            <small class="text-muted">Normal: {{ test.normal_range }}</small>
                            {% if analysis_results.test_explanations and analysis_results.test_explanations[test.test_name] %}
                            <div class="mt-2">
                                <small class="text-info">{{ analysis_results.test_explanations[test.test_name][:100] }}...</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Disease Risks -->
{% if analysis_results.disease_risks %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Health Risk Assessment
                </h5>
            </div>
            <div class="card-body">
                {% for risk in analysis_results.disease_risks %}
                <div class="alert {% if risk.risk_level == 'high' %}alert-danger{% elif risk.risk_level == 'medium' %}alert-warning{% else %}alert-info{% endif %} mb-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="alert-heading">{{ risk.disease_name }}</h6>
                            <p class="mb-2">{{ risk.description }}</p>
                            <small><strong>Risk Level:</strong> {{ risk.risk_level.title() }} ({{ (risk.confidence * 100)|round }}% confidence)</small>
                        </div>
                        <span class="badge {% if risk.risk_level == 'high' %}bg-danger{% elif risk.risk_level == 'medium' %}bg-warning{% else %}bg-info{% endif %}">
                            {{ risk.risk_level.title() }}
                        </span>
                    </div>
                    {% if risk.recommendations %}
                    <hr>
                    <strong>Recommendations:</strong>
                    <ul class="mb-0 mt-2">
                        {% for rec in risk.recommendations[:3] %}
                        <li>{{ rec }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Health Insights, Action Plan, and Consequences -->
{% if analysis_results.summary or analysis_results.recommendations or (analysis_results.narrative and analysis_results.narrative.summary_text) %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Health Insights</h6>
            </div>
            <div class="card-body">
                {% if analysis_results.summary %}
                <h6>Summary</h6>
                <p class="text-muted">{{ analysis_results.summary }}</p>
                {% endif %}
                {% if analysis_results.recommendations %}
                <h6>Recommendations</h6>
                <ul class="list-unstyled">
                    {% for recommendation in analysis_results.recommendations %}
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>{{ recommendation }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% if analysis_results.narrative and analysis_results.narrative.summary_text %}
                <hr>
                <h6>Narrative Summary</h6>
                <p>{{ analysis_results.narrative.summary_text }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if analysis_results.action_plan %}
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h6 class="mb-0"><i class="fas fa-list-check me-2"></i>Action Plan</h6>
    </div>
    <div class="card-body">
        <div class="list-group list-group-flush">
            {% for action in analysis_results.action_plan %}
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="ms-0 me-auto">
                        <div class="fw-bold">{{ action.title }}</div>
                        <div class="text-muted small">{{ action.details }}</div>
                        <div class="mt-1">
                            <span class="badge bg-secondary me-2"><i class="far fa-clock me-1"></i>{{ action.when }}</span>
                            <span class="badge bg-light text-dark"><i class="far fa-user me-1"></i>{{ action.who }}</span>
                        </div>
                    </div>
                    <span class="badge {% if action.priority == 'immediate' %}bg-danger{% elif action.priority == 'soon' %}bg-warning text-dark{% else %}bg-success{% endif %} rounded-pill text-uppercase">{{ action.priority }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% if analysis_results.consequences_if_ignored %}
<div class="card mb-4">
    <div class="card-header bg-danger text-white">
        <h6 class="mb-0"><i class="fas fa-triangle-exclamation me-2"></i>If You Do Nothing</h6>
    </div>
    <div class="card-body">
        <ul class="mb-0">
            {% for c in analysis_results.consequences_if_ignored %}
            <li class="mb-2">{{ c }}</li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endif %}

<!-- Key Findings and Consequences -->
{% if analysis_results.key_findings or analysis_results.consequences_if_ignored %}
<div class="row">
    {% if analysis_results.key_findings %}
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-microscope me-2"></i>
                    Key Findings
                </h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    {% for item in analysis_results.key_findings %}
                    <li class="mb-2">{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    {% if analysis_results.consequences_if_ignored %}
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0">
                    <i class="fas fa-triangle-exclamation me-2"></i>
                    If You Do Nothing
                </h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    {% for c in analysis_results.consequences_if_ignored %}
                    <li class="mb-2">{{ c }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Next Steps -->
{% if analysis_results.next_steps %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-route me-2"></i>
                    Your Next Steps
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for step in analysis_results.next_steps %}
                    <div class="col-md-6 mb-2">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-arrow-right text-primary me-2"></i>
                            <span>{{ step }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Original Report Content -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt me-2"></i>
                    Original Report Content
                    <button class="btn btn-sm btn-outline-primary ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#extractedText">
                        <i class="fas fa-eye me-1"></i>
                        View Full Text
                    </button>
                </h5>
            </div>
            <div class="collapse" id="extractedText">
                <div class="card-body">
                    <div class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                        <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9em;">{{ report.extracted_text or 'No text extracted from the uploaded file.' }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Section -->
{% if analysis_results.summary %}
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle me-2"></i>WellWrap Analysis Summary</h6>
            <p class="mb-0">{{ analysis_results.summary }}</p>
        </div>
    </div>
</div>
{% endif %}

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: none;
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,0.125);
}

.alert {
    border-left: 4px solid;
}

.alert-danger {
    border-left-color: #dc3545;
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-info {
    border-left-color: #0dcaf0;
}

pre {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

.display-4 {
    font-size: 3rem;
}

.card .card-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
}

.card .card-header.bg-primary {
    background: linear-gradient(135deg, var(--secondary-color), var(--info-color)) !important;
}

.card .card-header.bg-success {
    background: linear-gradient(135deg, var(--success-color), #2ecc71) !important;
}

.card .card-header.bg-info {
    background: linear-gradient(135deg, var(--info-color), #17a2b8) !important;
}

.card .card-header.bg-secondary {
    background: linear-gradient(135deg, #6c757d, #95a5a6) !important;
}

.card .card-header.bg-danger {
    background: linear-gradient(135deg, var(--danger-color), #e74c3c) !important;
}

.badge {
    font-size: 0.75em;
}

pre {
    font-size: 0.9em;
    line-height: 1.4;
    border-radius: 10px;
    border: 1px solid #dee2e6;
}
</style>

{% endblock %}