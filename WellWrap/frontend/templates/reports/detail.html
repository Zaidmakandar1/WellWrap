{% extends "base.html" %}

{% block title %}Report Analysis - Healthcare Portal{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-custom">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('patient_history') }}">History</a></li>
        <li class="breadcrumb-item active">Report Analysis</li>
    </ol>
</nav>

<div class="row">
    <div class="col-12">
        <div class="card card-custom">
            <div class="card-header card-header-custom">
                <h4 class="mb-0">
                    <i class="fas fa-file-medical me-2"></i>
                    Medical Report Analysis
                </h4>
                <div class="mt-2">
                    <small>
                        <i class="fas fa-calendar me-1"></i>
                        Uploaded: {{ report.upload_date.strftime('%B %d, %Y at %I:%M %p') }}
                    </small>
                </div>
            </div>
            <div class="card-body">
                <!-- Report Info -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle me-2"></i>Report Information</h6>
                        <ul class="list-unstyled">
                            <li><strong>Original File:</strong> {{ report.original_filename }}</li>
                            <li><strong>Report Type:</strong> {{ report.report_type }}</li>
                            <li><strong>Status:</strong> 
                                <span class="badge {% if report.status == 'analyzed' %}bg-success{% elif report.status == 'pending' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ report.status.title() }}
                                </span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-line me-2"></i>Health Score</h6>
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="display-4 fw-bold 
{% if report.health_score is not none and report.health_score >= 80 %}text-success
                                    {% elif report.health_score is not none and report.health_score >= 60 %}text-warning
                                    {% else %}text-danger{% endif %}">
                                    {{ report.health_score or 0 }}
                                </div>
                                <small class="text-muted">out of 100</small>
                            </div>
                            <div>
                                {% set score = report.health_score or 0 %}
                                {% if score >= 80 %}
                                    <i class="fas fa-smile fa-3x text-success"></i>
                                    <div class="mt-1"><small class="text-success">Good Health</small></div>
                                {% elif score >= 60 %}
                                    <i class="fas fa-meh fa-3x text-warning"></i>
                                    <div class="mt-1"><small class="text-warning">Fair Health</small></div>
                                {% else %}
                                    <i class="fas fa-frown fa-3x text-danger"></i>
                                    <div class="mt-1"><small class="text-danger">Needs Attention</small></div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Results -->
                {% if analysis_results %}
                <div class="row">
                    <!-- Extracted Values -->
                    {% if analysis_results.extracted_values %}
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-vial me-2"></i>
                                    Extracted Test Results
                                </h6>
                            </div>
                            <div class="card-body">
                                {% for test in analysis_results.extracted_values %}
                                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                    <div>
                                        <strong>{{ test.test.title() }}</strong>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold">{{ test.value }}</div>
                                        <span class="badge {% if test.status == 'normal' %}bg-success{% else %}bg-warning{% endif %}">
                                            {{ test.status.title() }}
                                        </span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Summary & Recommendations -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    Health Insights
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if analysis_results.summary %}
                                <h6>Summary</h6>
                                <p class="text-muted">{{ analysis_results.summary }}</p>
                                {% endif %}

                                {% if analysis_results.recommendations %}
                                <h6>Recommendations</h6>
                                <ul class="list-unstyled">
                                    {% for recommendation in analysis_results.recommendations %}
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        {{ recommendation }}
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% endif %}

                                {% if analysis_results.narrative and analysis_results.narrative.summary_text %}
                                <hr>
                                <h6>Narrative Summary</h6>
                                <p>{{ analysis_results.narrative.summary_text }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Plan -->
                {% if analysis_results.action_plan %}
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-list-check me-2"></i>
                            Action Plan
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for action in analysis_results.action_plan %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="ms-0 me-auto">
                                        <div class="fw-bold">{{ action.title }}</div>
                                        <div class="text-muted small">{{ action.details }}</div>
                                        <div class="mt-1">
                                            <span class="badge bg-secondary me-2"><i class="far fa-clock me-1"></i>{{ action.when }}</span>
                                            <span class="badge bg-light text-dark"><i class="far fa-user me-1"></i>{{ action.who }}</span>
                                        </div>
                                    </div>
                                    <span class="badge {% if action.priority == 'immediate' %}bg-danger{% elif action.priority == 'soon' %}bg-warning text-dark{% else %}bg-success{% endif %} rounded-pill text-uppercase">{{ action.priority }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Key Findings and Consequences -->
                {% if analysis_results.key_findings or analysis_results.consequences_if_ignored %}
                <div class="row">
                    {% if analysis_results.key_findings %}
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-microscope me-2"></i>
                                    Key Findings
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    {% for item in analysis_results.key_findings %}
                                    <li class="mb-2">{{ item }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if analysis_results.consequences_if_ignored %}
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-triangle-exclamation me-2"></i>
                                    If You Do Nothing
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    {% for c in analysis_results.consequences_if_ignored %}
                                    <li class="mb-2">{{ c }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endif %}

                <!-- Extracted Text Section -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-file-alt me-2"></i>
                            Original Report Text
                            <button class="btn btn-sm btn-outline-secondary float-end" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#extractedText">
                                <i class="fas fa-eye me-1"></i>View
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="extractedText">
                        <div class="card-body">
                            <pre class="bg-light p-3" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;">{{ report.extracted_text or 'No text extracted' }}</pre>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row mt-4">
                    <div class="col-12 text-center">
                        <a href="{{ url_for('patient_history') }}" class="btn btn-outline-primary me-2">
                            <i class="fas fa-arrow-left me-2"></i>
                            Back to History
                        </a>
                        <a href="{{ url_for('upload_report') }}" class="btn btn-primary-custom">
                            <i class="fas fa-plus me-2"></i>
                            Upload Another Report
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Medical Disclaimer -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-warning-custom" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Medical Disclaimer:</strong> This analysis is for educational purposes only. 
            Always consult with qualified healthcare professionals for medical advice and treatment decisions.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .display-4 {
        font-size: 3rem;
    }
    
    .card .card-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
    }
    
    .card .card-header.bg-primary {
        background: linear-gradient(135deg, var(--secondary-color), var(--info-color)) !important;
    }
    
    .card .card-header.bg-success {
        background: linear-gradient(135deg, var(--success-color), #2ecc71) !important;
    }

    .card .card-header.bg-info {
        background: linear-gradient(135deg, var(--info-color), #17a2b8) !important;
    }
    
    .card .card-header.bg-secondary {
        background: linear-gradient(135deg, #6c757d, #95a5a6) !important;
    }

    .card .card-header.bg-danger {
        background: linear-gradient(135deg, var(--danger-color), #e74c3c) !important;
    }
    
    .badge {
        font-size: 0.75em;
    }
    
    pre {
        font-size: 0.9em;
        line-height: 1.4;
        border-radius: 10px;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}
