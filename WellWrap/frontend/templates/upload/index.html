{% extends "base.html" %}

{% block title %}Upload Report - Healthcare Portal{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-custom">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('dashboard') }}">
                        <i class="fas fa-tachometer-alt me-1"></i>
                        Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item active">Upload Report</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-1" style="color: var(--primary-color);">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Upload Medical Report
                </h2>
                <p class="text-muted mb-0">
                    Upload your medical reports for AI-powered analysis and insights
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Upload Area -->
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card card-custom">
            <div class="card-header card-header-custom">
                <h5 class="mb-0">
                    <i class="fas fa-file-upload me-2"></i>
                    Select Medical Report
                </h5>
            </div>
            <div class="card-body p-5">
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <!-- Drag and Drop Area -->
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <div id="uploadContent">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <h4>Drag & Drop Your Report Here</h4>
                            <p class="text-muted mb-3">or <strong>click to browse</strong></p>
                            <p class="text-muted small">
                                <i class="fas fa-info-circle me-1"></i>
                                Supported formats: PDF, JPG, JPEG, PNG (max 16MB)
                            </p>
                        </div>
                        
                        <div id="uploadProgress" class="d-none">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin fa-3x mb-3" style="color: var(--secondary-color);"></i>
                                <h5>Processing your report...</h5>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         id="progressBar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <p class="text-muted mt-2 mb-0" id="progressText">Uploading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <input type="file" id="fileInput" name="file" class="d-none" 
                           accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileSelect(this.files[0])">
                    
                    <!-- File Info Display -->
                    <div id="fileInfo" class="mt-4 d-none">
                        <div class="alert alert-info-custom">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-alt fa-2x me-3"></i>
                                    <div>
                                        <h6 class="mb-1" id="fileName"></h6>
                                        <small class="text-muted">
                                            <span id="fileSize"></span> â€¢ 
                                            <span id="fileType"></span>
                                        </small>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                    <i class="fas fa-times"></i>
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Options -->
                    <div class="row mt-4" id="uploadOptions" style="display: none;">
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-calendar me-1"></i>
                                Report Date (Optional)
                            </label>
                            <input type="date" class="form-control" name="report_date">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-tag me-1"></i>
                                Report Type (Optional)
                            </label>
                            <select class="form-control" name="report_type">
                                <option value="">Auto-detect</option>
                                <option value="Blood Test">Blood Test</option>
                                <option value="Lipid Panel">Lipid Panel</option>
                                <option value="Metabolic Panel">Metabolic Panel</option>
                                <option value="Thyroid Function">Thyroid Function</option>
                                <option value="General">General Report</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Upload Button -->
                    <div class="d-grid mt-4" id="submitSection" style="display: none;">
                        <button type="submit" class="btn btn-primary-custom btn-lg" id="submitBtn">
                            <i class="fas fa-brain me-2"></i>
                            Analyze Report with AI
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sample Reports -->
        <div class="card card-custom mt-4">
            <div class="card-header card-header-custom">
                <h6 class="mb-0">
                    <i class="fas fa-vial me-2"></i>
                    Try Sample Reports
                </h6>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Don't have a report handy? Try our demo analysis with sample medical reports:
                </p>
                <div class="row g-3">
                    <div class="col-md-4">
                        <button class="btn btn-outline-danger w-100" onclick="loadSampleReport('anemia')">
                            <i class="fas fa-tint me-2"></i>
                            Anemia Sample
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-warning w-100" onclick="loadSampleReport('lipid')">
                            <i class="fas fa-heart me-2"></i>
                            Lipid Panel Sample
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-info w-100" onclick="loadSampleReport('comprehensive')">
                            <i class="fas fa-clipboard-list me-2"></i>
                            Comprehensive Sample
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- How Analysis Works -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card card-custom">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <h4 style="color: var(--primary-color);">
                        <i class="fas fa-cogs me-2"></i>
                        How Our AI Analysis Works
                    </h4>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-3 text-center">
                        <div class="p-3">
                            <div class="rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center"
                                 style="width: 70px; height: 70px; background: linear-gradient(135deg, var(--info-color), var(--secondary-color)); color: white;">
                                <i class="fas fa-file-alt fa-2x"></i>
                            </div>
                            <h6>Text Extraction</h6>
                            <p class="text-muted small">Advanced OCR extracts all text from your PDF or image reports</p>
                        </div>
                    </div>
                    
                    <div class="col-md-3 text-center">
                        <div class="p-3">
                            <div class="rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center"
                                 style="width: 70px; height: 70px; background: linear-gradient(135deg, var(--success-color), #2ecc71); color: white;">
                                <i class="fas fa-search fa-2x"></i>
                            </div>
                            <h6>Pattern Recognition</h6>
                            <p class="text-muted small">AI identifies medical tests, values, and key health indicators</p>
                        </div>
                    </div>
                    
                    <div class="col-md-3 text-center">
                        <div class="p-3">
                            <div class="rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center"
                                 style="width: 70px; height: 70px; background: linear-gradient(135deg, var(--warning-color), #e67e22); color: white;">
                                <i class="fas fa-brain fa-2x"></i>
                            </div>
                            <h6>AI Analysis</h6>
                            <p class="text-muted small">Medical AI analyzes results and detects potential health conditions</p>
                        </div>
                    </div>
                    
                    <div class="col-md-3 text-center">
                        <div class="p-3">
                            <div class="rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center"
                                 style="width: 70px; height: 70px; background: linear-gradient(135deg, var(--danger-color), #c0392b); color: white;">
                                <i class="fas fa-clipboard-check fa-2x"></i>
                            </div>
                            <h6>Health Insights</h6>
                            <p class="text-muted small">Get personalized recommendations and easy-to-understand results</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Security & Privacy -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-success-custom" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-shield-alt fa-2x me-3"></i>
                <div>
                    <h6 class="mb-1">Your Privacy & Security</h6>
                    <p class="mb-0">
                        All uploads are encrypted and processed securely. Your medical data is never shared 
                        and automatically deleted after 30 days. We comply with HIPAA privacy standards.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .upload-area {
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .upload-area.drag-over {
        border-color: var(--success-color) !important;
        background: rgba(39, 174, 96, 0.1) !important;
    }
    
    .upload-area.drag-over .upload-icon {
        color: var(--success-color) !important;
    }
    
    #uploadContent h4 {
        color: var(--primary-color);
        margin-bottom: 1rem;
    }
    
    .progress-bar-animated {
        background: linear-gradient(90deg, var(--secondary-color), var(--info-color));
    }
    
    .file-preview {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let selectedFile = null;

// Drag and Drop functionality
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });
    
    // Handle dropped files
    uploadArea.addEventListener('drop', handleDrop, false);
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight(e) {
        uploadArea.classList.add('drag-over');
    }
    
    function unhighlight(e) {
        uploadArea.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    }
});

function handleFileSelect(file) {
    if (!file) return;
    
    // Validate file
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
    const maxSize = 16 * 1024 * 1024; // 16MB
    
    // Some browsers may not provide MIME for certain files; allow by extension fallback
    const ext = (file.name.split('.').pop() || '').toLowerCase();
    const typeOk = allowedTypes.includes(file.type) || ['pdf', 'jpg', 'jpeg', 'png'].includes(ext);
    if (!typeOk) {
        alert('Please select a PDF, JPG, JPEG, or PNG file.');
        return;
    }
    
    if (file.size > maxSize) {
        alert('File size must be less than 16MB.');
        return;
    }
    
    selectedFile = file;
    
    // Display file info (guard DOM lookups)
    const nameEl = document.getElementById('fileName');
    if (nameEl) nameEl.textContent = file.name;
    const sizeEl = document.getElementById('fileSize');
    if (sizeEl) sizeEl.textContent = formatFileSize(file.size);
    const typeEl = document.getElementById('fileType');
    const typeText = (file.type && file.type.includes('/')) ? file.type.split('/').pop().toUpperCase() : ext.toUpperCase();
    if (typeEl) typeEl.textContent = typeText;
    
    // Show file info and options
    const infoEl = document.getElementById('fileInfo');
    if (infoEl) infoEl.classList.remove('d-none');
    const optsEl = document.getElementById('uploadOptions');
    if (optsEl) optsEl.style.display = 'block';
    const submitEl = document.getElementById('submitSection');
    if (submitEl) submitEl.style.display = 'block';
    
    // Hide upload content
    const contentEl = document.getElementById('uploadContent');
    if (contentEl) contentEl.style.display = 'none';
    
    // Update upload area appearance (leave file input intact; only replace inner of uploadArea)
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
        uploadArea.style.minHeight = 'auto';
        uploadArea.style.padding = '2rem';
        uploadArea.innerHTML = `
        <div class="text-center">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h5 class="text-success">File Ready for Analysis</h5>
            <p class="text-muted mb-0">${file.name}</p>
        </div>
    `;
    }
}

function clearFile() {
    selectedFile = null;
    const inputEl = document.getElementById('fileInput');
    if (inputEl) inputEl.value = '';
    const infoEl = document.getElementById('fileInfo');
    if (infoEl) infoEl.classList.add('d-none');
    const optsEl = document.getElementById('uploadOptions');
    if (optsEl) optsEl.style.display = 'none';
    const submitEl = document.getElementById('submitSection');
    if (submitEl) submitEl.style.display = 'none';
    const contentEl = document.getElementById('uploadContent');
    if (contentEl) contentEl.style.display = 'block';
    
    // Reset upload area
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
        uploadArea.style.minHeight = '300px';
        uploadArea.style.padding = '';
        uploadArea.innerHTML = `
        <div id="uploadContent">
            <i class="fas fa-cloud-upload-alt upload-icon"></i>
            <h4>Drag & Drop Your Report Here</h4>
            <p class="text-muted mb-3">or <strong>click to browse</strong></p>
            <p class="text-muted small">
                <i class="fas fa-info-circle me-1"></i>
                Supported formats: PDF, JPG, JPEG, PNG (max 16MB)
            </p>
        </div>
    `;
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function loadSampleReport(type) {
    // Create a mock file for demonstration
    let sampleData = '';
    let fileName = '';
    
    switch(type) {
        case 'anemia':
            sampleData = `COMPLETE BLOOD COUNT REPORT
Patient: Demo Patient
Date: ${new Date().toLocaleDateString()}

RESULTS:
Hemoglobin: 8.5 g/dL (Normal: 12.0-15.5 g/dL) *LOW*
Hematocrit: 25.2% (Normal: 36.0-44.0%) *LOW*
White Blood Cells: 6.8 K/uL (Normal: 4.0-11.0 K/uL) Normal
Platelets: 180 K/uL (Normal: 150-450 K/uL) Normal`;
            fileName = 'sample_anemia_report.txt';
            break;
        case 'lipid':
            sampleData = `LIPID PROFILE REPORT
Patient: Demo Patient
Date: ${new Date().toLocaleDateString()}

LIPID PANEL RESULTS:
Total Cholesterol: 245 mg/dL (Desirable: <200 mg/dL) *HIGH*
LDL Cholesterol: 165 mg/dL (Optimal: <100 mg/dL) *HIGH*
HDL Cholesterol: 35 mg/dL (Desirable: >40 mg/dL) *LOW*
Triglycerides: 280 mg/dL (Normal: <150 mg/dL) *HIGH*`;
            fileName = 'sample_lipid_report.txt';
            break;
        case 'comprehensive':
            sampleData = `COMPREHENSIVE METABOLIC PANEL
Patient: Demo Patient
Date: ${new Date().toLocaleDateString()}

RESULTS:
Glucose: 145 mg/dL (Normal: 70-100 mg/dL) *HIGH*
Creatinine: 1.8 mg/dL (Normal: 0.6-1.3 mg/dL) *HIGH*
BUN: 28 mg/dL (Normal: 7-20 mg/dL) *HIGH*
ALT: 95 U/L (Normal: 7-56 U/L) *HIGH*
AST: 88 U/L (Normal: 10-40 U/L) *HIGH*`;
            fileName = 'sample_comprehensive_report.txt';
            break;
    }
    
    // Submit sample data
    submitSampleData(sampleData, fileName);
}

function submitSampleData(data, fileName) {
    // Show progress
    showProgress();
    
    // Simulate upload and redirect to analysis
    setTimeout(() => {
        // Create a form with sample data and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/upload';
        
        // Create a blob from the sample data
        const blob = new Blob([data], { type: 'text/plain' });
        const file = new File([blob], fileName, { type: 'text/plain' });
        
        // Create FormData and append the file
        const formData = new FormData();
        formData.append('file', file);
        
        // Submit via fetch to avoid page reload issues
        fetch('/upload', {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                return response.text();
            }
            throw new Error('Upload failed');
        }).then(html => {
            // Check if response contains a redirect (typically report view)
            if (html.includes('Medical Report Analysis') || response.redirected) {
                window.location.href = response.url || '/dashboard';
            } else {
                window.location.reload(); // Reload to show any error messages
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Error uploading sample report. Please try again.');
        }).finally(() => {
            hideProgress();
        });
    }, 2000);
}

function showProgress() {
    document.getElementById('uploadContent').style.display = 'none';
    document.getElementById('uploadProgress').classList.remove('d-none');
    
    // Animate progress bar
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            progressText.textContent = 'Analysis complete! Redirecting...';
        }
        progressBar.style.width = progress + '%';
    }, 200);
}

function hideProgress() {
    document.getElementById('uploadProgress').classList.add('d-none');
    document.getElementById('uploadContent').style.display = 'block';
}

// Form submission
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    if (!selectedFile) {
        e.preventDefault();
        alert('Please select a file first.');
        return;
    }
    
    // Show progress
    showProgress();
    
    // Update submit button
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
});
</script>
{% endblock %}
